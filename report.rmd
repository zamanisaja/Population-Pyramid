---
title: "Shiny Application"
author: "Sadjad Zamani"
always_allow_html: true
output: 
  html_document:
    keep_md: true
---
```{r include=FALSE}
# some global options
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_knit$set(cache = TRUE)
knitr::opts_chunk$set(fig.path = "./figure/")
knitr::opts_chunk$set(fig.align = "center")
```


## Introduction
In this demo I want to plot the age demographics of different countries around the world.
I'm getting the data from [The World Bank](https://www.worldbank.org/en/home) using this [api](https://github.com/gshs-ornl/wbstats)


## Packages
```{r packages}
library(wbstats)
library(tidyverse)
library(ggplot2)
wb_search("population ages.*male")[1:5, ]
```

```{r load_data}
# array of ["SP.POP.0004.FE" .. "SP.POP.2024.MA" .. ]
indicators <- paste(rep(
    c(
        "SP.POP.0004", "SP.POP.0509",
        paste("SP.POP.", 5 * c(2:15), 5 * c(2:15) + 4, sep = ""),
        "SP.POP.80UP"
    ), 2
), c(".FE", ".MA"), sep = "")

# to get the orginal data I used this command
# df <- wb_data(indicator = indicators, start_date = 2001, end_date = 2020)
df <- read_csv2("data.csv", show_col_types = FALSE)

df <- left_join(
    df,
    wb_countries()[, c("iso2c", "region")],
    by = c("iso2c")
)

df <- df %>%
    ##
    mutate(region = if_else(country == "Namibia", "Sub-Saharan Africa", region))

df <- df %>%
    relocate(region, .after = "country") %>%
    select(-c("iso2c", "iso3c")) %>%
    rename(year = date)
```

```{r}
df <- df %>%
    pivot_longer(
        cols = indicators,
        names_to = c("age", "gender"),
        names_pattern = "SP.POP.(.*).(..)",
        values_to = "population"
    ) %>%
    mutate(gender = if_else(gender == "FE", "Female", "Male")) %>%
    mutate(gender = as.factor(gender)) %>%
    mutate(age = if_else(age == "80UP", "80+", age)) %>%
    mutate(age = paste(substr(age, 1, 2), "-", substr(age, 3, 4), sep = "")) %>%
    mutate(age = as.factor(age))
```

```{r}
which_country <- "Iran, Islamic Rep."
which_year <- 2010

g <- df %>%
    filter(country == which_country, year == which_year) %>%
    mutate(population = population / 1000) %>%
    mutate(population = ifelse(gender == "Male", population * (-1), population * 1)) %>%
    ggplot() +
    aes(x = age, y = population, fill = gender) +
    geom_bar(stat = "identity") +
    coord_flip() +
    labs(
        title = paste("Population of", country, "(", year, ")"),
        x = "Age",
        y = "Population(in thousands)"
    )

g
```